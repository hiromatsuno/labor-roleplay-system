# アップデート内容（バージョン 1.1.0）

## 修正日: 2024年12月

---

## 🔧 修正内容

### 1. ワンクリックコピー機能の修正 ✅

**問題点:**
- pyperclipライブラリを使用したクリップボードコピーが機能していなかった
- ブラウザ環境ではpyperclipが正常に動作しない

**解決策:**
- pyperclipライブラリの使用を廃止
- Streamlitのネイティブ機能(`st.code()`)を使用
- ユーザーが直接テキストを選択してコピーする方式に変更

**変更後の動作:**
1. プロンプトが生成される
2. コードボックスに表示される
3. ユーザーがテキストを選択してCtrl+C (Cmd+C) でコピー

**メリット:**
- より確実にコピーできる
- すべてのブラウザで動作する
- 追加ライブラリが不要

---

### 2. カスタム作成の自動提案機能 ✅

**新機能:**
カテゴリーを選択すると、そのカテゴリーに関連する入力候補が自動的に表示されます。

**動作フロー:**
```
1. カテゴリーを選択（例: メンタルヘルス）
   ↓
2. 該当カテゴリーの既存テンプレートから候補を抽出
   ↓
3. 各項目で「候補から選択」または「独自に入力」を選べる
```

**対応項目:**
- ✅ シナリオタイトル
- ✅ 相談内容
- ✅ 背景情報
- ✅ 相談者の態度

**使い方:**
1. **カテゴリー選択**: 12種類のカテゴリーから選択
2. **入力方法選択**: 各項目で以下を選択可能
   - 「候補から選択」: 既存テンプレートの内容を利用
   - 「独自に入力」: オリジナルの内容を入力
3. **プロンプト生成**: 「プロンプトを生成」ボタンをクリック

**メリット:**
- 入力の手間が大幅に軽減
- 既存テンプレートを参考にできる
- 初心者でも簡単にカスタムシナリオを作成可能

---

### 3. 文字数制限とバリデーション ✅

**追加された制限:**

#### プロンプト全体の制限（1,000文字）
- **生成されたプロンプト全体**: 最大1,000文字
- これはAIチャットに貼り付ける最終的なプロンプトの文字数制限です

**バリデーション機能:**
1. **プロンプト生成後の文字数表示**
   ```
   ✅ プロンプト文字数: 845/1,000文字
   ```

2. **エラーメッセージ**
   - 1,000文字超過時: 
     ```
     ⚠️ プロンプトが1,234文字です。1,000文字を超えています。内容を短縮してください。
     ```

3. **成功メッセージ**
   ```
   ✅ プロンプト文字数: 845/1,000文字
   ```

**重要な仕様:**
- 個別項目（相談内容、背景情報など）には文字数制限はありません
- **最終的に生成されるプロンプト全体**が1,000文字以内であることが重要です
- 1,000文字を超えた場合は警告が表示されますが、プロンプトは生成されます
- その場合は内容を短縮して再生成してください

**メリット:**
- AIの処理制限を超えない
- 簡潔で効果的なプロンプトの作成を促進
- ユーザーへの明確なフィードバック

---

## 📋 その他の改善点

### UIの改善
- エラーメッセージがより明確に
- 成功メッセージの追加
- カテゴリー選択後の情報表示

### コードの最適化
- 不要なライブラリの削除(pyperclip)
- バリデーション機能の強化
- エラーハンドリングの改善

---

## 🔄 アップデート手順

### 既にデプロイ済みの場合

#### Streamlit Community Cloudを使用している場合:
1. GitHubのリポジトリにアクセス
2. 以下の3つのファイルを新しいバージョンで上書き:
   - `labor_roleplay_app.py`
   - `prompt_templates.py`
   - `requirements.txt`
3. 数分待つと自動的に反映されます

**手順の詳細:**
```
1. GitHubリポジトリのファイルをクリック
2. 鉛筆マーク(Edit)をクリック
3. 内容を新しいファイルの内容で置き換え
4. "Commit changes"をクリック
```

#### Dockerを使用している場合:
```bash
# 1. 新しいファイルをサーバーにコピー
scp labor_roleplay_app.py user@server:/opt/labor-roleplay-system/
scp prompt_templates.py user@server:/opt/labor-roleplay-system/
scp requirements.txt user@server:/opt/labor-roleplay-system/

# 2. コンテナを再起動
docker-compose down
docker-compose up -d --build
```

### 初めてデプロイする場合:
「デプロイ手順_超簡単版.md」を参照してください。

---

## 🆕 新機能の使い方

### カスタム作成の自動提案を使う

**例: ハラスメント関連のシナリオを作成**

1. **カテゴリー選択**
   - 「ハラスメント」を選択

2. **情報メッセージの確認**
   ```
   💡 ハラスメントカテゴリーの入力例が表示されます。参考にしてください。
   ```

3. **タイトル入力**
   - 「候補から選択」を選ぶと:
     - "ハラスメント被害の訴え"
     - "パワハラと指導の境界線"
   - または「独自に入力」で自由に入力

4. **相談内容入力**
   - 「候補から選択」でテンプレートの内容を利用
   - または「独自に入力」でオリジナルの内容を作成
   - 文字数が自動表示される: `文字数: 245/1,000`

5. **背景情報入力**
   - 同様に選択または入力

6. **相談者の態度入力**
   - 候補から選択（重複は自動除去されている）

7. **プロンプト生成**
   - すべて入力したら「プロンプトを生成」をクリック

---

## ⚠️ 注意事項

### 文字数について
- **プロンプト全体**: 1,000文字を超えないことを推奨
- 個別項目（相談内容、背景情報など）には制限はありませんが、最終的なプロンプトが1,000文字以内になるように調整してください
- 制限を超えるとエラーメッセージが表示されます
- 1,000文字を超えても生成はされますが、内容を短縮することをお勧めします

### コピー機能について
- 自動コピーボタンは削除されました
- テキストボックスから手動でコピーしてください
- Ctrl+A (すべて選択) → Ctrl+C (コピー) が便利です

### 既存のシナリオ
- 既存の12個のテンプレートは変更ありません
- すべて正常に動作します

---

## 🐛 バグ修正

### 修正されたバグ:
1. ✅ クリップボードコピーが動作しない問題
2. ✅ フォーム送信後の状態管理の問題
3. ✅ 長すぎるプロンプトが生成される問題

### 既知の問題:
現時点でなし

---

## 📞 サポート

### 問題が発生した場合:
1. ブラウザのキャッシュをクリア
2. ページを再読み込み(F5)
3. それでも解決しない場合はIT部門に連絡

### フィードバック:
- 新機能の使用感
- 改善提案
- バグ報告

すべて歓迎します!

---

## 📊 変更ファイル一覧

| ファイル名 | 変更内容 | 重要度 |
|-----------|---------|--------|
| labor_roleplay_app.py | コピー機能修正、自動提案機能追加、バリデーション追加 | ★★★ |
| prompt_templates.py | get_category_suggestions関数追加 | ★★☆ |
| requirements.txt | pyperclip削除 | ★☆☆ |

---

**バージョン**: 1.0.0 → 1.1.0
**リリース日**: 2024年12月
**互換性**: 既存のデータ・設定との互換性あり
